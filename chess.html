<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Chess</title>
<link rel="stylesheet" type="text/css" href="slides/slides.css"></head>
<body>
<h1>Chess</h1>
<div class="slides">
<div>
<div>
<h1>Chess</h1>
</div>
<ul><li>
a small chess playing program
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@Def(<span class="name">file: chess.cpp</span>)</span><br/>
<span class="in1"></span><span class="macro">@put(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="type">int</span> <span class="fn">main</span>() {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">setup</span>)</span>;<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">main loop</span>)</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">file: chess.cpp</span>)</span><br/>
</code></div>
<ul><li>
simple <code><span class="fn">main</span></code> function
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="var">iostream</span>&gt;<br/>
<span class="macro">@end(<span class="name">globals</span>)</span><br/>
</code></div>
<ul><li>
needs <code><span class="type">std</span>::<span class="var">cin</span></code>, <code><span class="type">std</span>::<span class="var">cout</span></code>, <code><span class="type">std</span>::<span class="var">cerr</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">main loop</span>)</span><br/>
<span class="in1"></span><span class="keyword">for</span> (;;) {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">cout</span> &lt;&lt; <span class="str">"?&gt; "</span>;<br/>
<span class="in2"></span><span class="type">std</span>::<span class="type">string</span> <span class="var">cmd</span>;<br/>
<span class="in2"></span><span class="keyword">if</span> (! (<span class="type">std</span>::<span class="var">cin</span> &gt;&gt; <span class="var">cmd</span>)) {<br/>
<span class="in3"></span><span class="keyword">break</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">do cmd</span>)</span>;<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">unknown cmd</span>)</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">main loop</span>)</span><br/>
</code></div>
<ul><li>
simple read/process loop
</li><li>
terminate on end of file
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">unknown cmd</span>)</span><br/>
<span class="in1"></span><span class="type">std</span>::<span class="var">cerr</span> &lt;&lt; <span class="str">"unknown command "</span> &lt;&lt;<br/>
<span class="in2"></span><span class="var">cmd</span> &lt;&lt; <span class="str">"\n"</span>;<br/>
<span class="macro">@end(<span class="name">unknown cmd</span>)</span><br/>
</code></div>
<ul><li>
message for unknown inputs
</li></ul>
</div>
</div>
<h2>Print board</h2>
<div class="slides">
<div>
<div>
<h2>Print board</h2>
</div>
<ul><li>
first task is to print the board
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="keyword">using</span> <span class="type">Elem</span> = <span class="type">signed</span> <span class="type">char</span>;<br/>
<span class="in1"></span><span class="macro">@put(<span class="name">board prereqs</span>)</span>;<br/>
<span class="in1"></span><span class="type">Elem</span> <span class="var">board</span>[<span class="num">120</span>] {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">initial board</span>)</span><br/>
<span class="in1"></span>};<br/>
<span class="macro">@end(<span class="name">globals</span>)</span><br/>
</code></div>
<ul><li>
board consists of 12 rows (ranks) each row having 10 columns (files)
</li><li>
the boarder simplifies checking of legal moves
</li><li>
especially for legal knight moves
</li><li>
the boarder is initialized with 100 
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">board prereqs</span>)</span><br/>
<span class="in1"></span><span class="keyword">constexpr</span> <span class="type">Elem</span> <span class="var">XX</span> { <span class="num">100</span> };<br/>
<span class="in1"></span><span class="keyword">constexpr</span> <span class="type">Elem</span> <span class="var">X</span> { <span class="var">XX</span> };<br/>
<span class="in1"></span><span class="keyword">constexpr</span> <span class="type">Elem</span> <span class="var">EE</span> { <span class="num">0</span> };<br/>
<span class="macro">@end(<span class="name">board prereqs</span>)</span><br/>
</code></div>
<ul><li>
the constant <code><span class="var">XX</span></code> or <code><span class="var">X</span></code> is used for border fields
</li><li>
the constant <code><span class="var">EE</span></code> is used for empty fields
</li><li>
<code><span class="var">EE</span></code> must be <code><span class="num">0</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">board prereqs</span>)</span><br/>
<span class="in1"></span><span class="keyword">constexpr</span> <span class="type">Elem</span> <span class="var">WP</span> { <span class="num">1</span> };<br/>
<span class="in1"></span><span class="keyword">constexpr</span> <span class="type">Elem</span> <span class="var">WR</span> { <span class="num">2</span> };<br/>
<span class="in1"></span><span class="keyword">constexpr</span> <span class="type">Elem</span> <span class="var">WB</span> { <span class="num">3</span> };<br/>
<span class="in1"></span><span class="keyword">constexpr</span> <span class="type">Elem</span> <span class="var">WN</span> { <span class="num">4</span> };<br/>
<span class="in1"></span><span class="keyword">constexpr</span> <span class="type">Elem</span> <span class="var">WQ</span> { <span class="num">5</span> };<br/>
<span class="in1"></span><span class="keyword">constexpr</span> <span class="type">Elem</span> <span class="var">WK</span> { <span class="num">6</span> };<br/>
<span class="macro">@end(<span class="name">board prereqs</span>)</span><br/>
</code></div>
<ul><li>
constants for the white figures
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">board prereqs</span>)</span><br/>
<span class="in1"></span><span class="keyword">constexpr</span> <span class="type">Elem</span> <span class="var">BP</span> { -<span class="num">1</span> };<br/>
<span class="in1"></span><span class="keyword">constexpr</span> <span class="type">Elem</span> <span class="var">BR</span> { -<span class="num">2</span> };<br/>
<span class="in1"></span><span class="keyword">constexpr</span> <span class="type">Elem</span> <span class="var">BB</span> { -<span class="num">3</span> };<br/>
<span class="in1"></span><span class="keyword">constexpr</span> <span class="type">Elem</span> <span class="var">BN</span> { -<span class="num">4</span> };<br/>
<span class="in1"></span><span class="keyword">constexpr</span> <span class="type">Elem</span> <span class="var">BQ</span> { -<span class="num">5</span> };<br/>
<span class="in1"></span><span class="keyword">constexpr</span> <span class="type">Elem</span> <span class="var">BK</span> { -<span class="num">6</span> };<br/>
<span class="macro">@end(<span class="name">board prereqs</span>)</span><br/>
</code></div>
<ul><li>
constants for the black figures
</li><li>
black figures must have the negative value of the white figures
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">initial board</span>)</span><br/>
<span class="in1"></span><span class="var">X</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">X</span>,<br/>
<span class="in1"></span><span class="var">X</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">X</span>,<br/>
<span class="in1"></span><span class="var">X</span>, <span class="var">WR</span>, <span class="var">WN</span>, <span class="var">WB</span>, <span class="var">WQ</span>, <span class="var">WK</span>, <span class="var">WB</span>, <span class="var">WN</span>, <span class="var">WR</span>, <span class="var">X</span>,<br/>
<span class="in1"></span><span class="var">X</span>, <span class="var">WP</span>, <span class="var">WP</span>, <span class="var">WP</span>, <span class="var">WP</span>, <span class="var">WP</span>, <span class="var">WP</span>, <span class="var">WP</span>, <span class="var">WP</span>, <span class="var">X</span>,<br/>
<span class="in1"></span><span class="var">X</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">X</span>,<br/>
<span class="in1"></span><span class="var">X</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">X</span>,<br/>
<span class="in1"></span><span class="var">X</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">X</span>,<br/>
<span class="in1"></span><span class="var">X</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">EE</span>, <span class="var">X</span>,<br/>
<span class="in1"></span><span class="var">X</span>, <span class="var">BP</span>, <span class="var">BP</span>, <span class="var">BP</span>, <span class="var">BP</span>, <span class="var">BP</span>, <span class="var">BP</span>, <span class="var">BP</span>, <span class="var">BP</span>, <span class="var">X</span>,<br/>
<span class="in1"></span><span class="var">X</span>, <span class="var">BR</span>, <span class="var">BN</span>, <span class="var">BB</span>, <span class="var">BQ</span>, <span class="var">BK</span>, <span class="var">BB</span>, <span class="var">BN</span>, <span class="var">BR</span>, <span class="var">X</span>,<br/>
<span class="in1"></span><span class="var">X</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">X</span>,<br/>
<span class="in1"></span><span class="var">X</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">XX</span>, <span class="var">X</span><br/>
<span class="macro">@end(<span class="name">initial board</span>)</span><br/>
</code></div>
<ul><li>
empty fields are <code><span class="num">0</span></code>
</li><li>
white figures have positive values
</li><li>
black figures have negative values
</li><li>
the board is rotated: the top left corner is A1
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">setup</span>)</span><br/>
<span class="in1"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> <span class="var">_pieces_board</span>[] {<br/>
<span class="in2"></span><span class="str">"♚"</span>, <span class="str">"♛"</span>, <span class="str">"♞"</span>, <span class="str">"♝"</span>, <span class="str">"♜"</span>,<br/>
<span class="in2"></span><span class="str">"♟"</span>, <span class="str">"."</span>, <span class="str">"♙"</span>, <span class="str">"♖"</span>,<br/>
<span class="in2"></span><span class="str">"♗"</span>, <span class="str">"♘"</span>, <span class="str">"♕"</span>, <span class="str">"♔"</span><br/>
<span class="in1"></span>};<br/>
<span class="in1"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> *<span class="var">pieces_board</span> {<br/>
<span class="in2"></span><span class="var">_pieces_board</span> + <span class="num">6</span><br/>
<span class="in1"></span>};<br/>
<span class="macro">@end(<span class="name">setup</span>)</span><br/>
</code></div>
<ul><li>
UTF-8 character codes are available for all chess figures
</li><li>
a pointer to the empty field is used to allow for negative indices
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">do cmd</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">cmd</span> == <span class="str">"p"</span>) {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">cout</span> &lt;&lt; <span class="str">"\n"</span>;<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">print board</span>)</span>;<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">cout</span> &lt;&lt; <span class="str">"\n"</span>;<br/>
<span class="in2"></span><span class="keyword">continue</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">do cmd</span>)</span><br/>
</code></div>
<ul><li>
the <code><span class="var">p</span></code> command prints the board
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">print board</span>)</span><br/>
<span class="in1"></span><span class="keyword">for</span> (<span class="type">int</span> <span class="var">r</span> = <span class="num">7</span>; <span class="var">r</span> &gt;= <span class="num">0</span>; --<span class="var">r</span>) {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">cout</span> &lt;&lt; (<span class="var">r</span> + <span class="num">1</span>) &lt;&lt; <span class="str">" "</span>;<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">print board rank</span>)</span>;<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">cout</span> &lt;&lt; <span class="str">"\n"</span>;<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="type">std</span>::<span class="var">cout</span> &lt;&lt; <span class="str">"  abcdefgh\n\n"</span>;<br/>
<span class="macro">@end(<span class="name">print board</span>)</span><br/>
</code></div>
<ul><li>
go through each rank in reverse order
</li><li>
print the rank
</li><li>
and close with the file indices
</li><li>
each rank starts with the rank index
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="keyword">inline</span> <span class="type">int</span> <span class="fn">f_r_to_idx</span>(<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">f</span>, <span class="type">int</span> <span class="var">r</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">r</span> * <span class="num">10</span> + <span class="var">f</span> + <span class="num">21</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">globals</span>)</span><br/>
</code></div>
<ul><li>
get index for file <code><span class="var">f</span></code> and rank <code><span class="var">r</span></code>
</li><li>
each rank consists of 10 bytes
</li><li>
and the first two ranks must be skipped
</li><li>
so must the first file
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="keyword">inline</span> <span class="type">Elem</span> <span class="fn">get</span>(<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">f</span>, <span class="type">int</span> <span class="var">r</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">board</span>[<span class="fn">f_r_to_idx</span>(<span class="var">f</span>, <span class="var">r</span>)];<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">globals</span>)</span><br/>
</code></div>
<ul><li>
get piece value for a specific file <code><span class="var">f</span></code> and rank <code><span class="var">r</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">print board rank</span>)</span>;<br/>
<span class="in1"></span><span class="keyword">for</span> (<span class="type">int</span> <span class="var">f</span> = <span class="num">0</span>; <span class="var">f</span> &lt;= <span class="num">7</span>; ++<span class="var">f</span>) {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">cout</span> &lt;&lt; <span class="var">pieces_board</span>[<br/>
<span class="in3"></span><span class="fn">get</span>(<span class="var">f</span>, <span class="var">r</span>)<br/>
<span class="in2"></span>];<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">print board rank</span>)</span>;<br/>
</code></div>
<ul><li>
print figure
</li></ul>
</div>
</div>
<h2>Handle Material</h2>
<div class="slides">
<div>
<div>
<h2>Handle Material</h2>
</div>
<ul><li>
two counts for material are kept
</li><li>
the absolute value indicates how many pieces are still in play
</li><li>
the normal value indicates how big the advantage of white is
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="var">float</span> <span class="var">material</span> { <span class="num">0</span>.<span class="num">0f</span> };<br/>
<span class="in1"></span><span class="var">float</span> <span class="var">abs_material</span> { <span class="num">481</span>.<span class="num">0f</span> };<br/>
<span class="macro">@end(<span class="name">globals</span>)</span><br/>
</code></div>
<ul><li>
initialize values for full board
</li><li>
no advantage for any color
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">print board</span>)</span><br/>
<span class="in1"></span><span class="type">std</span>::<span class="var">cout</span> &lt;&lt; <span class="str">"  material: "</span> &lt;&lt;<br/>
<span class="in2"></span><span class="var">abs_material</span> &lt;&lt; <span class="str">" ("</span> &lt;&lt;<br/>
<span class="in2"></span><span class="var">material</span> &lt;&lt; <span class="str">")\n"</span>;<br/>
<span class="macro">@end(<span class="name">print board</span>)</span><br/>
</code></div>
<ul><li>
print absolute and relative value
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="type">const</span> <span class="var">float</span> <span class="var">_pieces_mat</span>[] {<br/>
<span class="in2"></span>-<span class="num">200</span>.<span class="num">0f</span>, -<span class="num">9</span>.<span class="num">0f</span>, -<span class="num">3</span>.<span class="num">25f</span>, -<span class="num">3</span>.<span class="num">5f</span>,<br/>
<span class="in2"></span>-<span class="num">5</span>.<span class="num">0f</span>, -<span class="num">1</span>.<span class="num">0f</span>, <span class="num">0</span>.<span class="num">0f</span>, <span class="num">1</span>.<span class="num">0f</span>, <span class="num">5</span>.<span class="num">0f</span>,<br/>
<span class="in2"></span><span class="num">3</span>.<span class="num">5f</span>, <span class="num">3</span>.<span class="num">25f</span>, <span class="num">9</span>.<span class="num">0f</span>, <span class="num">200</span>.<span class="num">0f</span><br/>
<span class="in1"></span>};<br/>
<span class="in1"></span><span class="type">const</span> <span class="var">float</span> *<span class="var">pieces_mat</span> {<br/>
<span class="in2"></span><span class="var">_pieces_mat</span> + <span class="num">6</span><br/>
<span class="in1"></span>};<br/>
<span class="macro">@end(<span class="name">globals</span>)</span><br/>
</code></div>
<ul><li>
each piece has a different value
</li><li>
offset is used again to allow negative indices
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="var">cmath</span>&gt;<br/>
<span class="macro">@end(<span class="name">globals</span>)</span><br/>
</code></div>
<ul><li>
needs <code><span class="fn">fabs</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">add</span>(<span class="type">Elem</span> <span class="var">e</span>) {<br/>
<span class="in2"></span><span class="var">float</span> <span class="var">m</span> { <span class="var">pieces_mat</span>[<span class="var">e</span>] };<br/>
<span class="in2"></span><span class="var">material</span> += <span class="var">m</span>;<br/>
<span class="in2"></span><span class="var">abs_material</span> += <span class="fn">fabs</span>(<span class="var">m</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">globals</span>)</span><br/>
</code></div>
<ul><li>
add piece <code><span class="var">f</span></code> to material count
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">sub</span>(<span class="type">Elem</span> <span class="var">e</span>) {<br/>
<span class="in2"></span><span class="var">float</span> <span class="var">m</span> { <span class="var">pieces_mat</span>[<span class="var">e</span>] };<br/>
<span class="in2"></span><span class="var">material</span> -= <span class="var">m</span>;<br/>
<span class="in2"></span><span class="var">abs_material</span> -= <span class="fn">fabs</span>(<span class="var">m</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">globals</span>)</span><br/>
</code></div>
<ul><li>
remove piece <code><span class="var">f</span></code> from material count
</li></ul>
</div>
</div>
<h2>Move Manually</h2>
<div class="slides">
<div>
<div>
<h2>Move Manually</h2>
</div>
<ul><li>
perform direct moves
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="type">bool</span> <span class="fn">is_pos</span>(<span class="type">const</span> <span class="type">char</span> *<span class="var">p</span>) {<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">p</span>[<span class="num">0</span>] &lt; <span class="str">'a'</span> || <span class="var">p</span>[<span class="num">0</span>] &gt; <span class="str">'h'</span>) {<br/>
<span class="in3"></span><span class="keyword">return</span> <span class="num">false</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">p</span>[<span class="num">1</span>] &lt; <span class="str">'1'</span> || <span class="var">p</span>[<span class="num">1</span>] &gt; <span class="str">'8'</span>) {<br/>
<span class="in3"></span><span class="keyword">return</span> <span class="num">false</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="num">true</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">globals</span>)</span><br/>
</code></div>
<ul><li>
a position consists of two characters
</li><li>
the first is the rank and the second the file
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">do cmd</span>)</span> {<br/>
<span class="in1"></span><span class="type">const</span> <span class="type">char</span> *<span class="var">cs</span> { <span class="var">cmd</span>.<span class="fn">c_str</span>() };<br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">cmd</span>.<span class="fn">size</span>() == <span class="num">4</span> &amp;&amp;<br/>
<span class="in2"></span><span class="fn">is_pos</span>(<span class="var">cs</span>) &amp;&amp; <span class="fn">is_pos</span>(<span class="var">cs</span> + <span class="num">2</span>)<br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">manual move</span>)</span>;<br/>
<span class="in2"></span><span class="keyword">continue</span>;<br/>
<span class="in1"></span>}<br/>
} <span class="macro">@end(<span class="name">do cmd</span>)</span><br/>
</code></div>
<ul><li>
a move consists of two positions: the from field and the to field
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="type">int</span> <span class="fn">pos_to_idx</span>(<span class="type">const</span> <span class="type">char</span> *<span class="var">p</span>) {<br/>
<span class="in2"></span><span class="keyword">if</span> (! <span class="fn">is_pos</span>(<span class="var">p</span>)) { <span class="keyword">return</span> <span class="num">0</span>; }<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">f</span> { <span class="var">p</span>[<span class="num">0</span>] - <span class="str">'a'</span> };<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">r</span> { <span class="var">p</span>[<span class="num">1</span>] - <span class="str">'1'</span> };<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="fn">f_r_to_idx</span>(<span class="var">f</span>, <span class="var">r</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">globals</span>)</span><br/>
</code></div>
<ul><li>
convert a position string to an index
</li><li>
by converting the position to file and rank
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="keyword">inline</span> <span class="type">void</span> <span class="fn">set</span>(<span class="type">int</span> <span class="var">pos</span>, <span class="type">Elem</span> <span class="var">e</span>) {<br/>
<span class="in2"></span><span class="fn">sub</span>(<span class="var">board</span>[<span class="var">pos</span>]);<br/>
<span class="in2"></span><span class="var">board</span>[<span class="var">pos</span>] = <span class="var">e</span>;<br/>
<span class="in2"></span><span class="fn">add</span>(<span class="var">board</span>[<span class="var">pos</span>]);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">globals</span>)</span><br/>
</code></div>
<ul><li>
set figure on field
</li><li>
and adjust material values
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="macro">@put(<span class="name">needed by move</span>)</span>;<br/>
<span class="in1"></span><span class="keyword">inline</span> <span class="type">void</span> <span class="fn">move</span>(<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">from</span>, <span class="type">int</span> <span class="var">to</span>, <span class="type">int</span> <span class="var">promo</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">from</span> &amp;&amp; <span class="var">to</span>) {<br/>
<span class="in3"></span><span class="fn">set</span>(<span class="var">to</span>, <span class="var">promo</span> ?: <span class="var">board</span>[<span class="var">from</span>]);<br/>
<span class="in3"></span><span class="fn">set</span>(<span class="var">from</span>, <span class="num">0</span>);<br/>
<span class="in3"></span><span class="macro">@put(<span class="name">switch color</span>)</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">globals</span>)</span><br/>
</code></div>
<ul><li>
if the positions are valid the material of the to field is subtracted
</li><li>
then the piece is moved
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">manual move</span>)</span><br/>
<span class="in1"></span><span class="type">int</span> <span class="var">from</span> { <span class="fn">pos_to_idx</span>(<span class="var">cs</span>) };<br/>
<span class="in1"></span><span class="type">int</span> <span class="var">to</span> { <span class="fn">pos_to_idx</span>(<span class="var">cs</span> + <span class="num">2</span>) };<br/>
<span class="in1"></span><span class="fn">move</span>(<span class="var">from</span>, <span class="var">to</span>, <span class="num">0</span>);<br/>
<span class="macro">@end(<span class="name">manual move</span>)</span><br/>
</code></div>
<ul><li>
calculate the indices of the from and to fields
</li><li>
and perform move
</li></ul>
</div>
</div>
<h2>Switch Move Colors</h2>
<div class="slides">
<div>
<div>
<h2>Switch Move Colors</h2>
</div>
<ul><li>
change the colors between black and white
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">needed by move</span>)</span><br/>
<span class="in1"></span><span class="type">struct</span> <span class="type">State</span> {<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">color</span> { <span class="num">1</span> };<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">state init</span>)</span>;<br/>
<span class="in1"></span>} <span class="var">state</span>;<br/>
<span class="macro">@end(<span class="name">needed by move</span>)</span><br/>
</code></div>
<ul><li>
keep the current state of the chess match
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">switch color</span>)</span><br/>
<span class="in1"></span><span class="var">state</span>.<span class="var">color</span> = -<span class="var">state</span>.<span class="var">color</span>;<br/>
<span class="macro">@end(<span class="name">switch color</span>)</span><br/>
</code></div>
<ul><li>
switch playing color between <code><span class="num">1</span></code> (white) and <code>-<span class="num">1</span></code> (black)
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="keyword">inline</span> <span class="type">bool</span> <span class="fn">is_wh</span>(<span class="type">int</span> <span class="var">c</span>) {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">c</span> &gt; <span class="num">0</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">globals</span>)</span><br/>
</code></div>
<ul><li>
how to determine that a color is white
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="keyword">inline</span> <span class="type">bool</span> <span class="fn">is_bl</span>(<span class="type">int</span> <span class="var">c</span>) {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">c</span> &lt; <span class="num">0</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">globals</span>)</span><br/>
</code></div>
<ul><li>
how to determine that a color is black
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">print board</span>)</span><br/>
<span class="in1"></span><span class="type">std</span>::<span class="var">cout</span> &lt;&lt; <span class="str">"  "</span> &lt;&lt;<br/>
<span class="in2"></span>(<span class="fn">is_wh</span>(<span class="var">state</span>.<span class="var">color</span>) ? <span class="str">"white"</span> :<br/>
<span class="in3"></span><span class="str">"black"</span>)  &lt;&lt; <span class="str">" is moving\n"</span>;<br/>
<span class="macro">@end(<span class="name">print board</span>)</span><br/>
</code></div>
<ul><li>
print which color is playing
</li></ul>
</div>
</div>
<h2>Calculate a move</h2>
<div class="slides">
<div>
<div>
<h2>Calculate a move</h2>
</div>
<ul><li>
the computer calculates the next move
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">do cmd</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">cmd</span> == <span class="str">"m"</span>) {<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">from</span> { <span class="num">0</span> }, <span class="var">to</span> { <span class="num">0</span> };<br/>
<span class="in2"></span><span class="type">Elem</span> <span class="var">promo</span> { <span class="var">EE</span> };<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">calc move</span>)</span>;<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">from</span> &amp;&amp; <span class="var">to</span>) {<br/>
<span class="in3"></span><span class="fn">move</span>(<span class="var">from</span>, <span class="var">to</span>, <span class="var">promo</span>);<br/>
<span class="in3"></span><span class="macro">@put(<span class="name">print move</span>)</span>;<br/>
<span class="in2"></span>} <span class="keyword">else</span> {<br/>
<span class="in3"></span><span class="type">std</span>::<span class="var">cout</span> &lt;&lt; <span class="str">"no move\n"</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="keyword">continue</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">do cmd</span>)</span><br/>
</code></div>
<ul><li>
the <code><span class="var">m</span></code> command computes a computer move
</li><li>
it is performed and printed
</li><li>
if no move is found an error message is printed instead
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">idx_to_pos</span>(<span class="type">char</span> *<span class="var">pos</span>, <span class="type">int</span> <span class="var">idx</span>) {<br/>
<span class="in2"></span><span class="var">pos</span>[<span class="num">0</span>] = <span class="var">idx</span> % <span class="num">10</span> + <span class="str">'a'</span> - <span class="num">1</span>;<br/>
<span class="in2"></span><span class="var">pos</span>[<span class="num">1</span>] = <span class="var">idx</span> / <span class="num">10</span> + <span class="str">'1'</span> - <span class="num">2</span>;<br/>
<span class="in2"></span><span class="var">pos</span>[<span class="num">2</span>] = <span class="str">'\0'</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">globals</span>)</span><br/>
</code></div>
<ul><li>
convert a valid index position to a string
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">print move</span>)</span><br/>
<span class="in1"></span><span class="type">char</span> <span class="var">pos</span>[<span class="num">3</span>];<br/>
<span class="in1"></span><span class="fn">idx_to_pos</span>(<span class="var">pos</span>, <span class="var">from</span>);<br/>
<span class="in1"></span><span class="type">std</span>::<span class="var">cout</span> &lt;&lt; <span class="var">pos</span>;<br/>
<span class="in1"></span><span class="fn">idx_to_pos</span>(<span class="var">pos</span>, <span class="var">to</span>);<br/>
<span class="in1"></span><span class="type">std</span>::<span class="var">cout</span> &lt;&lt; <span class="var">pos</span>;<br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">promo</span>) {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">cout</span> &lt;&lt; <span class="var">pieces_board</span>[<span class="var">promo</span>];<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="type">std</span>::<span class="var">cout</span> &lt;&lt; <span class="str">"\n"</span>;<br/>
<span class="macro">@end(<span class="name">print move</span>)</span><br/>
</code></div>
<ul><li>
print from and to positions
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="macro">@put(<span class="name">best move prereqs</span>)</span>;<br/>
<span class="in1"></span><span class="type">int</span> <span class="fn">best_move</span>(<br/>
<span class="in2"></span><span class="type">int</span> &amp;<span class="var">from</span>, <span class="type">int</span> &amp;<span class="var">to</span>, <span class="type">int</span> <span class="var">color</span>,<br/>
<span class="in2"></span><span class="var">float</span> &amp;<span class="var">best_wh</span>, <span class="var">float</span> &amp;<span class="var">best_bl</span>,<br/>
<span class="in2"></span><span class="type">Elem</span> &amp;<span class="var">promo</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">best move</span>)</span>;<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="fn">is_wh</span>(<span class="var">color</span>) ?<br/>
<span class="in3"></span><span class="var">best_wh</span> : <span class="var">best_bl</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">globals</span>)</span><br/>
</code></div>
<ul><li>
calculate the best move for a given color
</li><li>
current best values for white and black are kept separatedly
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">globals</span>)</span><br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="var">limits</span>&gt;<br/>
<span class="in1"></span><span class="keyword">using</span> <span class="var">nlf</span> =<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">numeric_limits</span>&lt;<span class="var">float</span>&gt;;<br/>
<span class="macro">@end(<span class="name">globals</span>)</span><br/>
</code></div>
<ul><li>
needs <code><span class="type">std</span>::<span class="var">numeric_limits</span>&lt;<span class="var">float</span>&gt;</code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">calc move</span>)</span><br/>
<span class="in1"></span><span class="keyword">constexpr</span> <span class="var">float</span> <span class="var">inf</span> {<br/>
<span class="in2"></span><span class="var">nlf</span>::<span class="fn">infinity</span>()<br/>
<span class="in1"></span>};<br/>
<span class="in1"></span><span class="var">float</span> <span class="var">best_w</span> { -<span class="num">1</span> * <span class="var">inf</span> };<br/>
<span class="in1"></span><span class="var">float</span> <span class="var">best_b</span> { <span class="var">inf</span> };<br/>
<span class="in1"></span><span class="fn">best_move</span>(<br/>
<span class="in2"></span><span class="var">from</span>, <span class="var">to</span>, <span class="var">state</span>.<span class="var">color</span>,<br/>
<span class="in2"></span><span class="var">best_w</span>, <span class="var">best_b</span>, <span class="var">promo</span><br/>
<span class="in1"></span>);<br/>
<span class="macro">@end(<span class="name">calc move</span>)</span><br/>
</code></div>
<ul><li>
initialize values with extremly conservative values
</li><li>
so any move found will top these values
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">best move prereqs</span>)</span><br/>
<span class="in1"></span><span class="keyword">inline</span> <span class="type">bool</span> <span class="fn">same_c</span>(<span class="type">int</span> <span class="var">p</span>, <span class="type">int</span> <span class="var">c</span>) {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">board</span>[<span class="var">p</span>] * <span class="var">c</span> &gt; <span class="num">0</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">best move prereqs</span>)</span><br/>
</code></div>
<ul><li>
has piece on board same color?
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">best move prereqs</span>)</span><br/>
<span class="in1"></span><span class="keyword">inline</span> <span class="type">bool</span> <span class="fn">opp_c</span>(<span class="type">int</span> <span class="var">p</span>, <span class="type">int</span> <span class="var">c</span>) {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">board</span>[<span class="var">p</span>] * <span class="var">c</span> &lt; <span class="num">0</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">best move prereqs</span>)</span><br/>
</code></div>
<ul><li>
has piece on board different color?
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">best move</span>)</span><br/>
<span class="in1"></span><span class="keyword">for</span> (<span class="type">int</span> <span class="var">i</span> = <span class="num">0</span>; <span class="var">i</span> &lt; <span class="num">120</span>; ++<span class="var">i</span>) {<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">board</span>[<span class="var">i</span>] != <span class="var">XX</span> &amp;&amp;<br/>
<span class="in3"></span><span class="fn">same_c</span>(<span class="var">i</span>, <span class="var">color</span>)<br/>
<span class="in2"></span>) {<br/>
<span class="in3"></span><span class="macro">@put(<span class="name">check for best move</span>)</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">best move</span>)</span><br/>
</code></div>
<ul><li>
no move can origin from a boarder field
</li><li>
neither from a field that has not a figure of the needed color
</li><li>
go into more specific checking for all other fields
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">moves prereqs</span>)</span><br/>
<span class="in1"></span><span class="macro">@put(<span class="name">pseudo moves prereqs</span>)</span><br/>
<span class="in1"></span><span class="keyword">template</span>&lt;<span class="keyword">typename</span> <span class="var">I</span>&gt;<br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">pseudo_moves</span>(<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">f</span>, <span class="type">const</span> <span class="var">I</span> &amp;<span class="var">it</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">pseudo moves</span>)</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">moves prereqs</span>)</span><br/>
</code></div>
<ul><li>
iterate over all pseudo-legal moves
</li><li>
that is all moves possible without checking if after that move the  own king is still in check
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">best move prereqs</span>)</span><br/>
<span class="in1"></span><span class="macro">@put(<span class="name">moves prereqs</span>)</span><br/>
<span class="in1"></span><span class="keyword">template</span>&lt;<span class="keyword">typename</span> <span class="var">I</span>&gt;<br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">moves</span>(<span class="type">int</span> <span class="var">f</span>, <span class="type">const</span> <span class="var">I</span> &amp;<span class="var">it</span>) {<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">c</span> {<br/>
<span class="in3"></span><span class="fn">is_wh</span>(<span class="var">board</span>[<span class="var">f</span>]) ? <span class="num">1</span> : -<span class="num">1</span><br/>
<span class="in2"></span>};<br/>
<span class="in2"></span><span class="fn">pseudo_moves</span>(<span class="var">f</span>, [&amp;](<br/>
<span class="in3"></span><span class="type">int</span> <span class="var">t</span>, <span class="type">Elem</span> <span class="var">e</span><br/>
<span class="in2"></span>) {<br/>
<span class="in3"></span><span class="macro">@put(<span class="name">check for check</span>)</span>;<br/>
<span class="in2"></span>});<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">best move prereqs</span>)</span><br/>
</code></div>
<ul><li>
iterate over all valid moves
</li><li>
for each pseudo-legal move the function checks if the move will place  (or keep) the own king in check
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">best move prereqs</span>)</span><br/>
<span class="in1"></span><span class="type">bool</span> <span class="fn">eval_move</span>(<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">f</span>, <span class="type">int</span> <span class="var">t</span>, <span class="type">int</span> <span class="var">c</span>,<br/>
<span class="in2"></span><span class="var">float</span> &amp;<span class="var">best_wh</span>, <span class="var">float</span> &amp;<span class="var">best_bl</span>,<br/>
<span class="in2"></span><span class="type">Elem</span> <span class="var">e</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="type">bool</span> <span class="var">better</span> { <span class="num">false</span> };<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">eval move</span>)</span>;<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">better</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">best move prereqs</span>)</span><br/>
</code></div>
<ul><li>
get a value for a move
</li><li>
higher values are better for white
</li><li>
lower values are better for black
</li><li>
returns <code><span class="num">true</span></code> if the move has improved <code><span class="var">best_wh</span></code> or <code><span class="var">best_bl</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">check for best move</span>)</span><br/>
<span class="in1"></span><span class="fn">moves</span>(<span class="var">i</span>, [&amp;](<span class="type">int</span> <span class="var">m</span>, <span class="type">Elem</span> <span class="var">e</span>) {<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="fn">eval_move</span>(<br/>
<span class="in3"></span><span class="var">i</span>, <span class="var">m</span>, <span class="var">color</span>,<br/>
<span class="in3"></span><span class="var">best_wh</span>, <span class="var">best_bl</span>, <span class="var">e</span><br/>
<span class="in2"></span>)) {<br/>
<span class="in3"></span><span class="var">from</span> = <span class="var">i</span>; <span class="var">to</span> = <span class="var">m</span>;<br/>
<span class="in3"></span><span class="var">promo</span> = <span class="var">e</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>});<br/>
<span class="macro">@end(<span class="name">check for best move</span>)</span><br/>
</code></div>
<ul><li>
iterate over all legal moves
</li><li>
if it is an improvement, save the move
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">eval move</span>)</span><br/>
<span class="in1"></span><span class="macro">@mul(<span class="name">make revertable move</span>)</span>;<br/>
<span class="in1"></span><span class="macro">@put(<span class="name">check for improvement</span>)</span>;<br/>
<span class="in1"></span><span class="macro">@mul(<span class="name">revert move</span>)</span>;<br/>
<span class="macro">@end(<span class="name">eval move</span>)</span><br/>
</code></div>
<ul><li>
perform the move but save the origin constellation
</li><li>
check if the new situation is an improvement
</li><li>
undo the move at the end
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">make revertable move</span>)</span><br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">old_f</span> { <span class="var">board</span>[<span class="var">f</span>] };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">old_t</span> { <span class="var">board</span>[<span class="var">t</span>] };<br/>
<span class="in1"></span><span class="fn">move</span>(<span class="var">f</span>, <span class="var">t</span>, <span class="var">e</span>);<br/>
<span class="macro">@end(<span class="name">make revertable move</span>)</span><br/>
</code></div>
<ul><li>
store everything to revert move before performing it
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">revert move</span>)</span><br/>
<span class="in1"></span><span class="fn">set</span>(<span class="var">t</span>, <span class="var">old_t</span>);<br/>
<span class="in1"></span><span class="fn">set</span>(<span class="var">f</span>, <span class="var">old_f</span>);<br/>
<span class="macro">@end(<span class="name">revert move</span>)</span><br/>
</code></div>
<ul><li>
revert move
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">check for improvement</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="fn">is_wh</span>(<span class="var">c</span>) &amp;&amp; <span class="var">material</span> &gt; <span class="var">best_wh</span>) {<br/>
<span class="in2"></span><span class="var">best_wh</span> = <span class="var">material</span>;<br/>
<span class="in2"></span><span class="var">better</span> = <span class="num">true</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">check for improvement</span>)</span><br/>
</code></div>
<ul><li>
an improvement if white is playing
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">check for improvement</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="fn">is_bl</span>(<span class="var">c</span>) &amp;&amp; <span class="var">material</span> &lt; <span class="var">best_bl</span>) {<br/>
<span class="in2"></span><span class="var">best_bl</span> = <span class="var">material</span>;<br/>
<span class="in2"></span><span class="var">better</span> = <span class="num">true</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">check for improvement</span>)</span><br/>
</code></div>
<ul><li>
an improvement if black is playing
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">pseudo moves</span>)</span><br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">p</span> { <span class="var">board</span>[<span class="var">f</span>] };<br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">p</span> == <span class="var">EE</span> || <span class="var">p</span> == <span class="var">XX</span>) { <span class="keyword">return</span>; }<br/>
<span class="in1"></span><span class="type">int</span> <span class="var">c</span> { <span class="fn">is_wh</span>(<span class="var">p</span>) ? <span class="num">1</span> : -<span class="num">1</span> };<br/>
<span class="in1"></span><span class="macro">@put(<span class="name">pseudo moves for piece</span>)</span>;<br/>
<span class="macro">@end(<span class="name">pseudo moves</span>)</span><br/>
</code></div>
<ul><li>
no move origins from an empty field or the boarder
</li><li>
the color of the origin field is saved
</li><li>
calculate the moves depending on the figure type
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">pseudo moves prereqs</span>)</span><br/>
<span class="in1"></span><span class="type">bool</span> <span class="fn">is_pseudo_valid</span>(<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">f</span>, <span class="type">int</span> <span class="var">t</span>, <span class="type">int</span> <span class="var">color</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="type">auto</span> <span class="var">x</span> { <span class="var">board</span>[<span class="var">t</span>] };<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">x</span> == <span class="var">XX</span>) { <span class="keyword">return</span> <span class="num">false</span>; }<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="fn">same_c</span>(<span class="var">t</span>, <span class="var">color</span>)) {<br/>
<span class="in3"></span><span class="keyword">return</span> <span class="num">false</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="num">true</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">pseudo moves prereqs</span>)</span><br/>
</code></div>
<ul><li>
a move is pseudo-valid if the target field is not on the boarder
</li><li>
and not populated by a figure of the same color
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">pseudo moves prereqs</span>)</span><br/>
<span class="in1"></span><span class="keyword">template</span>&lt;<span class="keyword">typename</span> <span class="var">I</span>&gt;<br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">add_if_valid</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="var">I</span> &amp;<span class="var">it</span>, <span class="type">int</span> <span class="var">f</span>, <span class="type">int</span> <span class="var">t</span>, <span class="type">int</span> <span class="var">c</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="fn">is_pseudo_valid</span>(<span class="var">f</span>, <span class="var">t</span>, <span class="var">c</span>)) {<br/>
<span class="in3"></span><span class="fn">it</span>(<span class="var">t</span>, <span class="num">0</span>);<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">pseudo moves prereqs</span>)</span><br/>
</code></div>
<ul><li>
process the move only if it is pseudo-valid
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">pseudo moves prereqs</span>)</span><br/>
<span class="in1"></span><span class="keyword">template</span>&lt;<span class="keyword">typename</span> <span class="var">I</span>&gt;<br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">add_row</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="var">I</span> &amp;<span class="var">it</span>, <span class="type">int</span> <span class="var">f</span>, <span class="type">int</span> <span class="var">c</span>, <span class="type">int</span> <span class="var">d</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="keyword">for</span> (<span class="type">int</span> <span class="var">x</span> { <span class="var">d</span> };; <span class="var">x</span> += <span class="var">d</span>) {<br/>
<span class="in3"></span><span class="fn">add_if_valid</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> + <span class="var">x</span>, <span class="var">c</span>);<br/>
<span class="in3"></span><span class="keyword">if</span> (<span class="var">board</span>[<span class="var">f</span> + <span class="var">x</span>] != <span class="num">0</span>) {<br/>
<span class="in4"></span><span class="keyword">break</span>;<br/>
<span class="in3"></span>}<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">pseudo moves prereqs</span>)</span><br/>
</code></div>
<ul><li>
iterates over a row of fields starting at <code><span class="var">f</span></code>
</li><li>
the iteration stops if a non-empty field is processed
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">pseudo moves for piece</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">p</span> == <span class="var">WN</span> || <span class="var">p</span> == <span class="var">BN</span>) {<br/>
<span class="in2"></span><span class="fn">add_if_valid</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> - <span class="num">21</span>, <span class="var">c</span>);<br/>
<span class="in2"></span><span class="fn">add_if_valid</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> - <span class="num">19</span>, <span class="var">c</span>);<br/>
<span class="in2"></span><span class="fn">add_if_valid</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> - <span class="num">12</span>, <span class="var">c</span>);<br/>
<span class="in2"></span><span class="fn">add_if_valid</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> - <span class="num">8</span>, <span class="var">c</span>);<br/>
<span class="in2"></span><span class="fn">add_if_valid</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> + <span class="num">8</span>, <span class="var">c</span>);<br/>
<span class="in2"></span><span class="fn">add_if_valid</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> + <span class="num">12</span>, <span class="var">c</span>);<br/>
<span class="in2"></span><span class="fn">add_if_valid</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> + <span class="num">19</span>, <span class="var">c</span>);<br/>
<span class="in2"></span><span class="fn">add_if_valid</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> + <span class="num">21</span>, <span class="var">c</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">pseudo moves for piece</span>)</span><br/>
</code></div>
<ul><li>
the knight can move to eight possible fields
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">pseudo moves for piece</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">p</span> == <span class="var">WP</span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">white pawn moves</span>)</span>;<br/>
<span class="in1"></span>} <span class="keyword">else</span> <span class="keyword">if</span> (<span class="var">p</span> == <span class="var">BP</span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">black pawn moves</span>)</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">pseudo moves for piece</span>)</span><br/>
</code></div>
<ul><li>
pawns are more complicated
</li><li>
special treatment for white and black pawns
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">pseudo moves prereqs</span>)</span><br/>
<span class="in1"></span><span class="keyword">template</span>&lt;<span class="keyword">typename</span> <span class="var">I</span>&gt;<br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">add_pawn</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="var">I</span> &amp;<span class="var">it</span>, <span class="type">int</span> <span class="var">f</span>, <span class="type">int</span> <span class="var">t</span>, <span class="type">int</span> <span class="var">c</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="fn">is_pseudo_valid</span>(<span class="var">f</span>, <span class="var">t</span>, <span class="var">c</span>)) {<br/>
<span class="in3"></span><span class="type">int</span> <span class="var">r</span> { <span class="var">t</span> / <span class="num">10</span> - <span class="num">2</span> };<br/>
<span class="in3"></span><span class="keyword">if</span> (<span class="var">r</span> == <span class="num">0</span> || <span class="var">r</span> == <span class="num">7</span>) {<br/>
<span class="in4"></span><span class="fn">it</span>(<span class="var">t</span>, <span class="var">WQ</span> * <span class="var">c</span>);<br/>
<span class="in4"></span><span class="fn">it</span>(<span class="var">t</span>, <span class="var">WN</span> * <span class="var">c</span>);<br/>
<span class="in4"></span><span class="fn">it</span>(<span class="var">t</span>, <span class="var">WB</span> * <span class="var">c</span>);<br/>
<span class="in4"></span><span class="fn">it</span>(<span class="var">t</span>, <span class="var">WR</span> * <span class="var">c</span>);<br/>
<span class="in3"></span>} <span class="keyword">else</span> { <br/>
<span class="in4"></span><span class="fn">it</span>(<span class="var">t</span>, <span class="num">0</span>);<br/>
<span class="in3"></span>}<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">pseudo moves prereqs</span>)</span><br/>
</code></div>
<ul><li>
pawn promotion
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">white pawn moves</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">board</span>[<span class="var">f</span> + <span class="num">10</span>] == <span class="num">0</span>) {<br/>
<span class="in2"></span><span class="fn">add_pawn</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> + <span class="num">10</span>, <span class="var">c</span>);<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="fn">opp_c</span>(<span class="var">f</span> + <span class="num">9</span>, <span class="var">c</span>)) {<br/>
<span class="in2"></span><span class="fn">add_pawn</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> + <span class="num">9</span>, <span class="var">c</span>);<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="fn">opp_c</span>(<span class="var">f</span> + <span class="num">11</span>, <span class="var">c</span>)) {<br/>
<span class="in2"></span><span class="fn">add_pawn</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> + <span class="num">11</span>, <span class="var">c</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">white pawn moves</span>)</span><br/>
</code></div>
<ul><li>
white pawns can move forward if the field is empty
</li><li>
white pawns can take other figures on the diagonal
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">white pawn moves</span>)</span><br/>
<span class="in1"></span><span class="type">int</span> <span class="var">r</span> { <span class="var">f</span> / <span class="num">10</span> - <span class="num">2</span> };<br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">r</span> == <span class="num">1</span> &amp;&amp; <span class="var">board</span>[<span class="var">f</span> + <span class="num">10</span>] == <span class="num">0</span> &amp;&amp;<br/>
<span class="in2"></span><span class="var">board</span>[<span class="var">f</span> + <span class="num">20</span>] == <span class="num">0</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="fn">add_if_valid</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> + <span class="num">20</span>, <span class="var">c</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">white pawn moves</span>)</span><br/>
</code></div>
<ul><li>
if a white pawn is on the origin rank it can move two ranks forward  if these two fields are empty
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">black pawn moves</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">board</span>[<span class="var">f</span> - <span class="num">10</span>] == <span class="num">0</span>) {<br/>
<span class="in2"></span><span class="fn">add_pawn</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> - <span class="num">10</span>, <span class="var">c</span>);<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="fn">opp_c</span>(<span class="var">f</span> - <span class="num">9</span>, <span class="var">c</span>)) {<br/>
<span class="in2"></span><span class="fn">add_pawn</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> - <span class="num">9</span>, <span class="var">c</span>);<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="fn">opp_c</span>(<span class="var">f</span> - <span class="num">11</span>, <span class="var">c</span>)) {<br/>
<span class="in2"></span><span class="fn">add_pawn</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> - <span class="num">11</span>, <span class="var">c</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">black pawn moves</span>)</span><br/>
</code></div>
<ul><li>
black pawns can move downward if the field is empty
</li><li>
black pawns can take other figures on the diagonal
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">black pawn moves</span>)</span><br/>
<span class="in1"></span><span class="type">int</span> <span class="var">r</span> { <span class="var">f</span> / <span class="num">10</span> - <span class="num">2</span> };<br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">r</span> == <span class="num">6</span> &amp;&amp; <span class="var">board</span>[<span class="var">f</span> - <span class="num">10</span>] == <span class="num">0</span> &amp;&amp;<br/>
<span class="in2"></span><span class="var">board</span>[<span class="var">f</span> - <span class="num">20</span>] == <span class="num">0</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="fn">add_if_valid</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> - <span class="num">20</span>, <span class="var">c</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">black pawn moves</span>)</span><br/>
</code></div>
<ul><li>
if a black pawn is on the origin rank it can move two ranks downward  if these two fields are empty
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">pseudo moves for piece</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">p</span> == <span class="var">WR</span> || <span class="var">p</span> == <span class="var">BR</span>) {<br/>
<span class="in2"></span><span class="fn">add_row</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">c</span>, -<span class="num">10</span>);<br/>
<span class="in2"></span><span class="fn">add_row</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">c</span>, -<span class="num">1</span>);<br/>
<span class="in2"></span><span class="fn">add_row</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">c</span>, <span class="num">1</span>);<br/>
<span class="in2"></span><span class="fn">add_row</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">c</span>, <span class="num">10</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">pseudo moves for piece</span>)</span><br/>
</code></div>
<ul><li>
rooks move on ranks or files
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">pseudo moves for piece</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">p</span> == <span class="var">WB</span> || <span class="var">p</span> == <span class="var">BB</span>) {<br/>
<span class="in2"></span><span class="fn">add_row</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">c</span>, -<span class="num">11</span>);<br/>
<span class="in2"></span><span class="fn">add_row</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">c</span>, -<span class="num">9</span>);<br/>
<span class="in2"></span><span class="fn">add_row</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">c</span>, <span class="num">9</span>);<br/>
<span class="in2"></span><span class="fn">add_row</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">c</span>, <span class="num">11</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">pseudo moves for piece</span>)</span><br/>
</code></div>
<ul><li>
bishops move on diagonals
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">pseudo moves for piece</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">p</span> == <span class="var">WQ</span> || <span class="var">p</span> == <span class="var">BQ</span>) {<br/>
<span class="in2"></span><span class="fn">add_row</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">c</span>, -<span class="num">11</span>);<br/>
<span class="in2"></span><span class="fn">add_row</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">c</span>, -<span class="num">10</span>);<br/>
<span class="in2"></span><span class="fn">add_row</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">c</span>, -<span class="num">9</span>);<br/>
<span class="in2"></span><span class="fn">add_row</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">c</span>, -<span class="num">1</span>);<br/>
<span class="in2"></span><span class="fn">add_row</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">c</span>, <span class="num">1</span>);<br/>
<span class="in2"></span><span class="fn">add_row</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">c</span>, <span class="num">10</span>);<br/>
<span class="in2"></span><span class="fn">add_row</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">c</span>, <span class="num">9</span>);<br/>
<span class="in2"></span><span class="fn">add_row</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">c</span>, <span class="num">11</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">pseudo moves for piece</span>)</span><br/>
</code></div>
<ul><li>
queens can move on ranks, files and diagonals
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">pseudo moves for piece</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">p</span> == <span class="var">WK</span> || <span class="var">p</span> == <span class="var">BK</span>) {<br/>
<span class="in2"></span><span class="fn">add_if_valid</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> - <span class="num">11</span>, <span class="var">c</span>);<br/>
<span class="in2"></span><span class="fn">add_if_valid</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> - <span class="num">10</span>, <span class="var">c</span>);<br/>
<span class="in2"></span><span class="fn">add_if_valid</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> - <span class="num">9</span>, <span class="var">c</span>);<br/>
<span class="in2"></span><span class="fn">add_if_valid</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> - <span class="num">1</span>, <span class="var">c</span>);<br/>
<span class="in2"></span><span class="fn">add_if_valid</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> + <span class="num">1</span>, <span class="var">c</span>);<br/>
<span class="in2"></span><span class="fn">add_if_valid</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> + <span class="num">9</span>, <span class="var">c</span>);<br/>
<span class="in2"></span><span class="fn">add_if_valid</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> + <span class="num">10</span>, <span class="var">c</span>);<br/>
<span class="in2"></span><span class="fn">add_if_valid</span>(<span class="var">it</span>, <span class="var">f</span>, <span class="var">f</span> + <span class="num">11</span>, <span class="var">c</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">pseudo moves for piece</span>)</span><br/>
</code></div>
<ul><li>
kings can move one field in any direction
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">check for check</span>)</span><br/>
<span class="in1"></span><span class="macro">@mul(<span class="name">make revertable move</span>)</span>;<br/>
<span class="in1"></span><span class="type">bool</span> <span class="var">in_check</span> { <span class="num">false</span> };<br/>
<span class="in1"></span><span class="keyword">for</span> (<span class="type">int</span> <span class="var">i</span> = <span class="num">0</span>; <span class="var">i</span> &lt; <span class="num">120</span>; ++<span class="var">i</span>) {<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="fn">opp_c</span>(<span class="var">i</span>, <span class="var">c</span>)) {<br/>
<span class="in3"></span><span class="macro">@put(<span class="name">attacks king?</span>)</span><br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="macro">@mul(<span class="name">revert move</span>)</span>;<br/>
<span class="in1"></span><span class="keyword">if</span> (! <span class="var">in_check</span>) { <span class="fn">it</span>(<span class="var">t</span>, <span class="var">e</span>); }<br/>
<span class="macro">@end(<span class="name">check for check</span>)</span><br/>
</code></div>
<ul><li>
perform the move
</li><li>
then see if any figure of the opposite color can take the own king
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">attacks king?</span>)</span><br/>
<span class="in1"></span><span class="fn">pseudo_moves</span>(<span class="var">i</span>, [&amp;](<span class="type">int</span> <span class="var">m</span>, <span class="type">Elem</span> <span class="var">e</span>) {<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">board</span>[<span class="var">m</span>] == <span class="var">WK</span> * <span class="var">c</span>) {<br/>
<span class="in3"></span><span class="var">in_check</span> = <span class="num">true</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>});<br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">in_check</span>) { <span class="keyword">break</span>; }<br/>
<span class="macro">@end(<span class="name">attacks king?</span>)</span><br/>
</code></div>
<ul><li>
can the own king be taken?
</li><li>
if so no reason to continue the loop
</li></ul>
</div>
</div>
<h2>Multiple Moves</h2>
<div class="slides">
<div>
<div>
<h2>Multiple Moves</h2>
</div>
<ul><li>
TODO
</li></ul>
</div>
</div>
<h2>En Passant</h2>
<div class="slides">
<div>
<div>
<h2>En Passant</h2>
</div>
<ul><li>
TODO
</li></ul>
</div>
</div>
<h2>Castling</h2>
<div class="slides">
<div>
<div>
<h2>Castling</h2>
</div>
<ul><li>
TODO
</li></ul>
</div>
</div>
<h2>Clear Board</h2>
<div class="slides">
<div>
<div>
<h2>Clear Board</h2>
</div>
<ul><li>
note essential
</li><li>
clears the board
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">do cmd</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">cmd</span> == <span class="str">"c"</span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">do clear</span>)</span>;<br/>
<span class="in2"></span><span class="keyword">continue</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">do cmd</span>)</span><br/>
</code></div>
<ul><li>
the <code><span class="var">c</span></code> command clears the board
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">do clear</span>)</span><br/>
<span class="in1"></span><span class="keyword">for</span> (<span class="type">int</span> <span class="var">r</span> = <span class="num">0</span>; <span class="var">r</span> &lt;= <span class="num">7</span>; ++<span class="var">r</span>) {<br/>
<span class="in2"></span><span class="keyword">for</span> (<span class="type">int</span> <span class="var">f</span> = <span class="num">0</span>; <span class="var">f</span> &lt;= <span class="num">7</span>; ++<span class="var">f</span>) {<br/>
<span class="in3"></span><span class="var">board</span>[<span class="fn">f_r_to_idx</span>(<span class="var">f</span>, <span class="var">r</span>)] = <span class="num">0</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="var">material</span> = <span class="var">abs_material</span> = <span class="num">0</span>.<span class="num">0f</span>;<br/>
<span class="macro">@end(<span class="name">do clear</span>)</span><br/>
</code></div>
<ul><li>
set each field to the empty field
</li><li>
and clear material counts
</li></ul>
</div>
</div>
<h2>Add Pieces</h2>
<div class="slides">
<div>
<div>
<h2>Add Pieces</h2>
</div>
<ul><li>
not essential
</li><li>
add black or white pieces
</li><li>
can also clear fields
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">do cmd</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">cmd</span> == <span class="str">"w"</span> || <span class="var">cmd</span> == <span class="str">"b"</span>) {<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">color</span> { <span class="var">cmd</span> == <span class="str">"w"</span> ? <span class="num">1</span> : -<span class="num">1</span> };<br/>
<span class="in2"></span><span class="keyword">for</span> (;;) {<br/>
<span class="in3"></span><span class="type">std</span>::<span class="type">string</span> <span class="var">piece</span>;<br/>
<span class="in3"></span><span class="type">std</span>::<span class="var">cin</span> &gt;&gt; <span class="var">piece</span>;<br/>
<span class="in3"></span><span class="keyword">if</span> (<span class="var">piece</span> == <span class="str">"."</span>) { <span class="keyword">break</span>; }<br/>
<span class="in3"></span><span class="macro">@put(<span class="name">add piece</span>)</span>;<br/>
<span class="in3"></span><span class="macro">@mul(<span class="name">unknown piece</span>)</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="keyword">continue</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">do cmd</span>)</span><br/>
</code></div>
<ul><li>
use the <code><span class="var">w</span></code> for adding white pieces
</li><li>
and <code><span class="var">b</span></code> for adding black pieces
</li><li>
afterwards specify the pieces to add
</li><li>
terminate the sequence with <code>.</code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">unknown piece</span>)</span><br/>
<span class="in1"></span><span class="type">std</span>::<span class="var">cerr</span> &lt;&lt; <span class="str">"unknown piece "</span> &lt;&lt;<br/>
<span class="in2"></span><span class="var">piece</span> &lt;&lt; <span class="str">"\n"</span>;<br/>
<span class="macro">@end(<span class="name">unknown piece</span>)</span><br/>
</code></div>
<ul><li>
signal wrong piece syntax
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">add piece</span>)</span><br/>
<span class="in1"></span><span class="type">const</span> <span class="type">char</span> *<span class="var">cs</span> { <span class="var">piece</span>.<span class="fn">c_str</span>() };<br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">piece</span>.<span class="fn">size</span>() == <span class="num">3</span> &amp;&amp;<br/>
<span class="in2"></span><span class="fn">is_pos</span>(<span class="var">cs</span> + <span class="num">1</span>)<br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">do add piece</span>)</span>;<br/>
<span class="in2"></span><span class="keyword">continue</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">add piece</span>)</span><br/>
</code></div>
<ul><li>
each piece starts with the kind of the piece
</li><li>
and a position
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">do add piece</span>)</span><br/>
<span class="in1"></span><span class="type">int</span> <span class="var">p</span> { <span class="fn">pos_to_idx</span>(<span class="var">cs</span> + <span class="num">1</span>) };<br/>
<span class="in1"></span><span class="keyword">switch</span> (<span class="var">cs</span>[<span class="num">0</span>]) {<br/>
<span class="in2"></span><span class="keyword">case</span> <span class="str">'.'</span>: <span class="fn">set</span>(<span class="var">p</span>, <span class="num">0</span>); <span class="keyword">break</span>;<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">put other pieces</span>)</span>;<br/>
<span class="in2"></span><span class="keyword">default</span>:<br/>
<span class="in3"></span><span class="macro">@mul(<span class="name">unknown piece</span>)</span>;<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="fn">add</span>(<span class="var">board</span>[<span class="var">p</span>]);<br/>
<span class="macro">@end(<span class="name">do add piece</span>)</span><br/>
</code></div>
<ul><li>
a piece can be removed with <code>.</code> and the position
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">put other pieces</span>)</span><br/>
<span class="in1"></span><span class="keyword">case</span> <span class="str">'P'</span>: <span class="fn">set</span>(<span class="var">p</span>, <span class="var">color</span> * <span class="var">WP</span>); <span class="keyword">break</span>;<br/>
<span class="in1"></span><span class="keyword">case</span> <span class="str">'R'</span>: <span class="fn">set</span>(<span class="var">p</span>, <span class="var">color</span> * <span class="var">WR</span>); <span class="keyword">break</span>;<br/>
<span class="in1"></span><span class="keyword">case</span> <span class="str">'B'</span>: <span class="fn">set</span>(<span class="var">p</span>, <span class="var">color</span> * <span class="var">WB</span>); <span class="keyword">break</span>;<br/>
<span class="in1"></span><span class="keyword">case</span> <span class="str">'N'</span>: <span class="fn">set</span>(<span class="var">p</span>, <span class="var">color</span> * <span class="var">WN</span>); <span class="keyword">break</span>;<br/>
<span class="in1"></span><span class="keyword">case</span> <span class="str">'Q'</span>: <span class="fn">set</span>(<span class="var">p</span>, <span class="var">color</span> * <span class="var">WQ</span>); <span class="keyword">break</span>;<br/>
<span class="in1"></span><span class="keyword">case</span> <span class="str">'K'</span>: <span class="fn">set</span>(<span class="var">p</span>, <span class="var">color</span> * <span class="var">WK</span>); <span class="keyword">break</span>;<br/>
<span class="macro">@end(<span class="name">put other pieces</span>)</span><br/>
</code></div>
<ul><li>
use uppercase letters to set the figure
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">add piece</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">piece</span>.<span class="fn">size</span>() == <span class="num">2</span> &amp;&amp; <span class="fn">is_pos</span>(<span class="var">cs</span>)) {<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">p</span> { <span class="fn">pos_to_idx</span>(<span class="var">cs</span>) };<br/>
<span class="in2"></span><span class="fn">set</span>(<span class="var">p</span>, <span class="var">color</span> * <span class="var">WP</span>);<br/>
<span class="in2"></span><span class="keyword">continue</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">add piece</span>)</span><br/>
</code></div>
</div>
</div>
<h2>Add State</h2>
<div class="slides">
<div>
<div>
<h2>Add State</h2>
</div>
<ul><li>
keep the current state of the chess match
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">state init</span>)</span><br/>
<span class="in1"></span><span class="type">bool</span> <span class="var">wh_o_o</span> { <span class="num">true</span> };<br/>
<span class="in1"></span><span class="type">bool</span> <span class="var">wh_o_o_o</span> { <span class="num">true</span> };<br/>
<span class="in1"></span><span class="type">bool</span> <span class="var">bl_o_o</span> { <span class="num">true</span> };<br/>
<span class="in1"></span><span class="type">bool</span> <span class="var">bl_o_o_o</span> { <span class="num">true</span> };<br/>
<span class="in1"></span><span class="type">int</span> <span class="var">e_p_field</span> { <span class="num">0</span> };<br/>
<span class="macro">@end(<span class="name">state init</span>)</span><br/>
</code></div>
<ul><li>
keep the current state of the chess match
</li></ul>
</div>
</body>
</html>
